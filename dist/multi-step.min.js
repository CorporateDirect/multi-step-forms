!function(){class e{constructor(e,i={}){if(!(e instanceof HTMLFormElement))throw new Error("FormManager expects a form element");this.form=e,this.currentStep=0,this.history=[0],this.options=Object.assign({progress:!0},i),this.stepManager=new s(this.form),this.navigation=new t(this.stepManager),this.memory=new r(this.form,this.stepManager),this.validation=new a(this.form),this.attachGlobalListeners(),this.form.addEventListener("editField",e=>{const{fieldName:t}=e.detail;this.editField(t)}),this.editContext=null;const o=this.form.querySelector('[data-form="summary"]');o&&(this.summary=new n(this.stepManager,this.memory,o),this.summary.update()),this.navigation.handleNext=()=>{const e=this.stepManager.steps[this.currentStep].element;this.validation.validateStep(e)?this.nextStep():this.navigation.triggerErrorShake&&this.navigation.triggerErrorShake()},this.navigation.handlePrevious=()=>{this.previousStep()},this.options.progress&&this._initProgressBar()}_initProgressBar(){this.progressContainer=document.createElement("div"),this.progressContainer.className="progress-container",this.progressBar=document.createElement("div"),this.progressBar.className="progress-bar",this.progressContainer.appendChild(this.progressBar),this.form.prepend(this.progressContainer),this._updateProgressBar()}_updateProgressBar(){this.progressBar&&(this.progressBar.style.width=this.getProgressPercent()+"%")}getProgressPercent(){const e=this.stepManager.steps.length;return Math.round((this.currentStep+1)/e*100)}init(){this.stepManager.discoverSteps(),this.stepManager.steps.forEach((e,t)=>{this._validateStructureCompatibility(e.element)}),this.goToStep(0)}goToStep(e){const t=this.currentStep,s=this.stepManager.steps.length;if(e<0||e>=s)return;console.log(`🚀 [FormManager] STEP PROGRESSION: ${this.currentStep} → ${e}`),console.log(`📋 [FormManager] Navigation history: [${this.history.join(" → ")}] → ${e}`),this.currentStep=e;this.history[this.history.length-1]!==e&&this.history.push(e),this.stepManager.showStep(e),this.navigation.currentIndex=e,this.navigation.updateButtonVisibility(),this.progressBar&&this._updateProgressBar(),this.summary&&t!==e&&this.summary.update(),t!==e&&(i(this.form),this._removeEditBar());const a=new CustomEvent("stepChange",{detail:{currentStep:e,totalSteps:this.stepManager.steps.length}});if(this.form.dispatchEvent(a),e===this.stepManager.steps.length-1&&t===e){const e=new Event("formComplete");this.form.dispatchEvent(e)}}nextStep(){const e=this.stepManager.steps[this.currentStep].element;this._validateStructureCompatibility(e);const t=this._findWrapperGraceful(e);if(!t)return void console.error("Could not find any wrapper element in the current step. Navigation halted.");const s=this._detectBranchingStep(e,t);let a=null;if(console.log(`🔍 [FormManager] Navigation analysis for step ${this.currentStep}:`),console.log(`🔍 [FormManager] Is branching step: ${s}`),s){const t=this._findCheckedRadioWithGoTo(e);if(!t)return console.warn("⚠️ [FormManager] Branching step: No radio button selected. Navigation halted."),void(this.navigation.triggerErrorShake&&this.navigation.triggerErrorShake());a=t.getAttribute("data-go-to"),console.log(`🔥 [FormManager] Branching navigation triggered. data-go-to: "${a}"`)}else a=this._findSequentialTarget(t,e),a&&console.log(`➡️ [FormManager] Sequential navigation triggered. data-go-to: "${a}"`);if(a){console.log(`🎯 [FormManager] Searching for target step with data-answer="${a}"`);const e=this.stepManager.steps.findIndex((e,t)=>{const s=null!==this._findAnswerElementGraceful(e.element,a);return console.log(`🔍 [FormManager]   Step ${t}: ${s?"✅ CONTAINS":"❌ does not contain"} data-answer="${a}"`),s});return void(e>-1?(this.stepManager.selectedAnswer=a,console.log(`🎉 [FormManager] SUCCESS! data-go-to="${a}" successfully targets data-answer="${a}" in step ${e}`),alert(`🎉 Navigation Success!\n\ndata-go-to="${a}" successfully found target data-answer="${a}" in step ${e}`),this.goToStep(e)):(console.error(`❌ [FormManager] Navigation failed: Could not find any step containing [data-answer="${a}"]`),alert(`❌ Navigation Error!\n\ndata-go-to="${a}" could not find matching data-answer="${a}" in any step`)))}console.log("🔄 [FormManager] Fallback navigation: Advancing to next step in DOM order."),this.goToStep(this.currentStep+1)}previousStep(){console.log(`⬅️ [FormManager] Going back from step ${this.currentStep} to step ${this.currentStep-1}`),this.goToStep(this.currentStep-1)}getCurrentStep(){return this.stepManager.steps[this.currentStep]||null}editField(e){if(!this.summary)return;const t=this.summary.getFieldLocation(e);t&&(this.editContext={fieldName:e},null!==t.wrapperAnswer&&(this.stepManager.selectedAnswer=t.wrapperAnswer),this.goToStep(t.stepIndex),setTimeout(()=>{const t=this.form.querySelector(`[name="${e}"]`);t&&(o(t),this._showEditBar(t)),this.editContext=null},100))}_showEditBar(e){this.editBar&&this._removeEditBar();const t=e.placeholder||e.dataset.label||e.name;console.log(`Edit mode started for field "${e.name}"`);const s=document.createElement("div");s.className="edit-mode-bar",s.innerHTML=`<span>Editing: <strong>${t}</strong></span>`;const a=document.createElement("button");a.type="button",a.className="save-return-btn",a.textContent="Save & Return to Summary",s.appendChild(a);const r=document.createElement("button");r.type="button",r.className="cancel-edit-btn",r.textContent="Cancel",s.appendChild(r);(e.closest("[data-answer]")||e.parentElement).prepend(s);const n=()=>{this.validation.validateField(e)?(console.log(`Field "${e.name}" validated, saving and returning to summary`),this.memory.saveAllFields(),s.classList.add("success"),this.summary&&this.summary.update(),setTimeout(()=>{this._navigateToSummary(),this._removeEditBar()},600)):(console.log(`Validation failed for field "${e.name}"`),s.classList.add("shake"),setTimeout(()=>s.classList.remove("shake"),400))};a.addEventListener("click",e=>{e.preventDefault(),n()}),r.addEventListener("click",t=>{t.preventDefault(),console.log(`Edit canceled for field "${e.name}"`),this._removeEditBar(),this._navigateToSummary()});const i=e=>{"Enter"===e.key?(e.preventDefault(),n()):"Escape"===e.key&&(e.preventDefault(),this._removeEditBar(),this._navigateToSummary())};e.addEventListener("keydown",i),s.dataset.cleanup="true",s._cleanup=()=>{e.removeEventListener("keydown",i)},this.editBar=s}_removeEditBar(){this.editBar&&(console.log("Edit bar removed"),this.editBar._cleanup&&this.editBar._cleanup(),this.editBar.remove(),this.editBar=null,i(this.form))}_navigateToSummary(){const e=this.summary?this.summary.stepManager.steps.length-1:this.stepManager.steps.length-1;this.goToStep(e)}_detectBranchingStep(e,t){if("true"===t.getAttribute("data-branch"))return!0;return null!==e.querySelector('[data-branch="true"]')}_findCheckedRadioWithGoTo(e){return this._findRadioGraceful(e)}_findSequentialTarget(e,t){if(e.hasAttribute("data-go-to"))return e.getAttribute("data-go-to");const s=t.querySelector("[data-go-to]");return s?s.getAttribute("data-go-to"):null}_detectStructureType(e){const t=e.querySelector(".step_wrapper[data-answer]"),s=e.querySelectorAll(".step_item[data-answer]");return t&&s.length>0?"mixed":s.length>0?"nested":"simple"}_findWrapperGraceful(e){let t=e.querySelector(".step_wrapper");return t||(t=e.querySelector("[data-answer]"),t&&console.warn("FormManager: Using fallback wrapper detection. Consider updating to .step_wrapper structure.")),t||(t=e,console.warn("FormManager: No .step_wrapper found, using step element as wrapper. This is deprecated.")),t}_findAnswerElementGraceful(e,t){let s=e.querySelector(`[data-answer="${t}"]`);if(!s){const a=e.querySelectorAll("[data-answer]");s=Array.from(a).find(e=>e.getAttribute("data-answer").toLowerCase()===t.toLowerCase()),s&&console.warn(`FormManager: Found answer element using case-insensitive search. Consider using exact case: "${t}"`)}return s}_findRadioGraceful(e){let t=e.querySelector('input[type="radio"][data-go-to]:checked');return t||(t=e.querySelector('input[type="radio"]:checked'),!t||t.hasAttribute("data-go-to"))?t:(console.warn("FormManager: Found checked radio without data-go-to attribute. Branching may not work correctly."),null)}_validateStructureCompatibility(e){const t=this._detectStructureType(e),s=Array.from(this.stepManager.steps).findIndex(t=>t.element===e);switch(t){case"simple":case"nested":break;case"mixed":console.warn(`FormManager: Step ${s} has mixed structure (both .step_wrapper[data-answer] and .step_item[data-answer]). This may cause unexpected behavior.`);break;default:console.warn(`FormManager: Step ${s} has unusual structure. Consider using .step_wrapper containers.`)}e.querySelectorAll("[data-target], [data-next]").length>0&&console.warn(`FormManager: Step ${s} contains deprecated attributes (data-target, data-next). Consider migrating to data-go-to and data-answer.`)}attachGlobalListeners(){this._globalListenersAttached||(this._globalListenersAttached=!0,document.addEventListener("click",e=>{const t=document.querySelector(".field-editing");t&&!t.contains(e.target)&&i(document)}),this.form.addEventListener("submit",()=>{i(this.form)}))}}document.addEventListener("DOMContentLoaded",()=>{});class t{constructor(e){this.stepManager=e,this.stepManager.steps&&this.stepManager.steps.length||this.stepManager.discoverSteps(),this.currentIndex=0,this.form=this.stepManager.root,this.createButtons(),this.attachListeners(),this.updateButtonVisibility()}createButtons(){}attachListeners(){this.form.addEventListener("click",e=>{const t=e.target.closest("[data-form]");if(!t)return;const s=t.getAttribute("data-form");"next-btn"===s?(e.preventDefault(),this.handleNext()):"back-btn"===s&&(e.preventDefault(),this.handlePrevious());const a=t.getAttribute("data-skip");if(a){e.preventDefault();const t=this.stepManager.steps.findIndex(e=>null!==e.element.querySelector(`[data-answer="${a}"]`));t>=0&&(this.currentIndex=t,this.stepManager.showStep(t),this.updateButtonVisibility())}})}handleNext(){const e=this.currentIndex+1;e<this.stepManager.steps.length&&(this.currentIndex=e,this.stepManager.showStep(this.currentIndex),this.updateButtonVisibility())}handlePrevious(){const e=this.currentIndex-1;e>=0&&(this.currentIndex=e,this.stepManager.showStep(this.currentIndex),this.updateButtonVisibility())}updateButtonVisibility(){}triggerErrorShake(){console.warn("Form validation failed - check required fields")}}class s{constructor(e=document){this.root=e,this.steps=[],this.selectedAnswer=""}discoverSteps(){const e=this.root.querySelectorAll('[data-form="step"]');return this.steps=Array.from(e).map((e,t)=>{const s=e.querySelectorAll("[data-answer]");return{element:e,index:t,wrappers:Array.from(s).map(e=>{const t=e.classList.contains("step_item"),s=e.classList.contains("step_wrapper");return{element:e,answer:e.getAttribute("data-answer"),type:t?"step_item":s?"step_wrapper":"other"}})}}),this.steps}hideAllSteps(){this.steps.length||this.discoverSteps(),this.steps.forEach(e=>{e.element.style.display="none"})}showStep(e){console.log(`[StepManager] 🔍 showStep called for index ${e}`),this.steps.length||this.discoverSteps(),console.log("[StepManager] 👁️ Step visibility changes:"),this.steps.forEach(t=>{const s=t.index===e;t.element.style.display=s?"flex":"none",console.log(`[StepManager]   Step ${t.index}: ${s?"✅ VISIBLE":"❌ HIDDEN"}`)});const t=this.steps[e];if(t){const s=0===e?"":this.selectedAnswer||"";console.log(`[StepManager] 🎯 Looking for wrapper with answer: "${s}"`),this.showWrapper(t,s)}}showWrapper(e,t=""){if(!e||!e.wrappers)return;console.log(`[StepManager] 🔧 showWrapper: searching for "${t}" among ${e.wrappers.length} wrappers`);let s=!1,a=null;if(e.wrappers.forEach((e,r)=>{const n=(e.answer||"")===t;console.log(`[StepManager]   Wrapper ${r}: data-answer="${e.answer||""}" type="${e.type}" ${n?"✅ MATCH":"❌ no match"}`),n?(a=e,e.element.style.display="flex",s=!0,console.log(`[StepManager] 🎯 TARGET FOUND: Showing wrapper with data-answer="${e.answer}"`)):e.element.style.display="none"}),s&&a&&"step_item"===a.type){const e=a.element.closest(".step_wrapper");e&&(e.style.display="flex",console.log("[StepManager] 🔗 Showing parent wrapper for step_item"));const t=a.element.parentElement;if(t){t.querySelectorAll(".step_item").forEach(e=>{e!==a.element&&(e.style.display="none")})}}if(!s&&e.wrappers.length){const t=e.wrappers[0];if(t.element.style.display="flex",console.log(`[StepManager] ⚠️ FALLBACK: No match found, showing first wrapper with data-answer="${t.answer}"`),"step_item"===t.type){const e=t.element.closest(".step_wrapper");e&&(e.style.display="flex")}}}}class a{constructor(e){this.form=e}validateStep(e){if(!e)return!0;if(e.hasAttribute("data-form-no-input"))return!0;this.clearErrors(e);let t=!0;return e.querySelectorAll("[required]").forEach(e=>{this.validateField(e)||(t=!1)}),t}validateField(e){if(!(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement))return!0;const t=e.type,s=e.name;let a=!0;if("radio"===t){const t=e.closest('[data-form="step"]').querySelectorAll(`input[type="radio"][name="${s}"]`);a=Array.from(t).some(e=>e.checked)}else if("checkbox"===t){a=e.checked}else a=""!==e.value.trim();return a||this.showError(e,"This field is required"),a}showError(e,t){e.classList.add("field-error");let s=e.parentElement.querySelector(".error-message");s||(s=document.createElement("div"),s.className="error-message",e.parentElement.appendChild(s)),s.textContent=t}clearErrors(e){e&&(e.querySelectorAll(".field-error").forEach(e=>e.classList.remove("field-error")),e.querySelectorAll(".error-message").forEach(e=>e.remove()))}}class r{constructor(e,t,s=500){this.form=e,this.stepManager=t,this.debounceMs=s,this.storageKey=`form-memory-${e.id||"default"}`,this.data=this._loadFromStorage(),this._saveTimeout=null,this.attachListeners(),this.restoreValues()}attachListeners(){this.form.addEventListener("change",e=>{const t=e.target;t.name&&this._saveFromElement(t)}),this.form.addEventListener("input",e=>{const t=e.target;t.name&&("textarea"!==t.tagName.toLowerCase()&&"text"!==t.type&&"email"!==t.type&&"number"!==t.type&&"url"!==t.type&&"tel"!==t.type||this._saveFromElement(t))})}saveField(e,t,s={}){e&&(this.data.values||(this.data.values={}),this.data.values[e]={value:t,timestamp:Date.now(),...s},this._debouncedPersist())}saveAllFields(){const e=this.form.elements;Array.from(e).forEach(e=>{(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement)&&e.name&&this._saveFromElement(e)}),this._persistToStorage()}getAllValues(){const e={};return Object.keys(this.data.values||{}).forEach(t=>{e[t]=this.data.values[t].value}),e}clear(){localStorage.removeItem(this.storageKey),this.data={values:{},lastUpdated:Date.now()}}restoreValues(){const e=this.data.values||{};Object.keys(e).forEach(t=>{const s=e[t],a=s.fieldType,r=this.form.querySelectorAll(`[name="${t}"]`);if(r.length)if("checkbox"===a){const e=Array.isArray(s.value)?s.value:[];r.forEach(t=>{t instanceof HTMLInputElement&&(t.checked=e.includes(t.value))})}else if("radio"===a)r.forEach(e=>{e instanceof HTMLInputElement&&(e.checked=e.value===s.value,e.checked&&e.dispatchEvent(new Event("change")))});else if("select"===a){const e=r[0];Array.isArray(s.value)?Array.from(e.options).forEach(e=>{e.selected=s.value.includes(e.value)}):e.value=s.value,e.dispatchEvent(new Event("change"))}else{const e=r[0];e.value=s.value,e.dispatchEvent(new Event("input"))}})}_getFieldType(e){return e instanceof HTMLSelectElement?"select":e instanceof HTMLTextAreaElement?"textarea":"checkbox"===e.type?"checkbox":"radio"===e.type?"radio":"text"}_getStepIndex(e){if(!this.stepManager)return-1;const t=e.closest('[data-form="step"]');if(!t)return-1;const s=this.stepManager.steps.find(e=>e.element===t);return s?s.index:-1}_isElementVisible(e){return!(null===e.offsetParent)}_saveFromElement(e){if(!e||!e.name)return;const t=e.name,s=this._getFieldType(e),a=this._getStepIndex(e),r=this._isElementVisible(e);let n;if("checkbox"===s){const e=this.form.querySelectorAll(`input[type="checkbox"][name="${t}"]`);n=Array.from(e).filter(e=>e.checked).map(e=>e.value)}else if("radio"===s)n=e.checked?e.value:this.data.values?.[t]?.value||"";else if("select"===s){const t=e;n=t.multiple?Array.from(t.selectedOptions).map(e=>e.value):t.value}else n=e.value;this.saveField(t,n,{stepIndex:a,fieldType:s,isVisible:r})}_loadFromStorage(){try{const e=localStorage.getItem(this.storageKey);if(e)return JSON.parse(e)}catch(e){console.warn("Memory: failed to parse stored data",e)}return{values:{},lastUpdated:Date.now()}}_debouncedPersist(){this._saveTimeout&&clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(()=>{this._persistToStorage()},this.debounceMs)}_persistToStorage(){this.data.lastUpdated=Date.now();try{localStorage.setItem(this.storageKey,JSON.stringify(this.data)),console.log("Memory: data persisted",this.data)}catch(e){console.warn("Memory: failed to save data",e)}}}class n{constructor(e,t,s){this.stepManager=e,this.memory=t,this.container=s}generate(){const e=[],t=this.memory.data.values||{};return Object.keys(t).forEach(s=>{const a=t[s];if(!a.isVisible)return;const r=a.stepIndex??-1,n=this.stepManager.steps[r];let i=`Step ${r+1}`;if(n)if(n.element.dataset.stepName)i=n.element.dataset.stepName;else{const e=n.element.querySelector("h2,h3");e&&e.textContent&&(i=e.textContent.trim())}let o=e.find(e=>e.index===r);o||(o={index:r,name:i,items:[]},e.push(o));const l=this._getFieldLabel(s);o.items.push({label:l,value:a.value,fieldName:s})}),e.sort((e,t)=>e.index-t.index),e}render(e=this.container){if(!e)return;const t=this.generate();e.innerHTML="",t.forEach(t=>{const s=document.createElement("div");s.className="summary-group";const a=document.createElement("h3");a.textContent=t.name,s.appendChild(a),t.items.forEach(e=>{const a=document.createElement("div");a.className="summary-item",a.dataset.fieldName=e.fieldName,a.dataset.stepIndex=t.index,a.style.cursor="pointer";const r=document.createElement("span");r.className="label",r.textContent=e.label;const n=document.createElement("span");n.className="value",Array.isArray(e.value)?n.textContent=e.value.join(", "):n.textContent=e.value;const i=document.createElement("span");i.className="edit-icon",i.textContent="✏️",a.appendChild(r),a.appendChild(n),a.appendChild(i),s.appendChild(a)}),e.appendChild(s)}),this.attachEditHandlers()}attachEditHandlers(){this.container.querySelectorAll(".summary-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.fieldName,s=parseInt(e.dataset.stepIndex,10);this.initiateFieldEdit(t,s)})})}initiateFieldEdit(e,t){this.editContext={fieldName:e,stepIndex:t};const s=new CustomEvent("editField",{detail:{fieldName:e}});this.stepManager.root.dispatchEvent(s)}getFieldLocation(e){const t=this.stepManager.root.querySelector(`[name="${e}"]`);if(!t)return null;const s=t.closest('[data-form="step"]');if(!s)return null;const a=this.stepManager.steps.find(e=>e.element===s),r=a?a.index:-1,n=t.closest("[data-answer]");return{stepIndex:r,wrapperAnswer:n?n.getAttribute("data-answer"):null}}update(){this.render()}_getFieldLabel(e){const t=this.stepManager.root.querySelector(`[name="${e}"]`);if(t){if(t.dataset.label)return t.dataset.label;if(t.placeholder)return t.placeholder;const e=t.closest("label");if(e){const t=e.cloneNode(!0);t.querySelectorAll("input,select,textarea").forEach(e=>e.remove());const s=t.textContent?.trim();if(s)return s}if(t.id){const e=this.stepManager.root.querySelector(`label[for="${t.id}"]`);if(e)return e.textContent?.trim()}}return e}}if(console.log("Multi-step form script loaded"),"undefined"!=typeof document){const t=()=>{document.querySelectorAll('[data-form="multistep"]').forEach(t=>{const s=new e(t);t.__formManager=s,s.init(),console.log("FormManager initialized:",s)})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}function i(e=document){e.querySelectorAll(".field-editing").forEach(e=>e.classList.remove("field-editing"))}function o(e,t=100){if(!e)return;i(e.ownerDocument),e.classList.add("field-editing");try{e.focus({preventScroll:!0})}catch{e.focus()}const s=e.getBoundingClientRect().top+window.scrollY-t;window.scrollTo({top:s,behavior:"smooth"})}"undefined"!=typeof window&&(window.FieldHighlight={highlightField:o,clearHighlight:i})}();